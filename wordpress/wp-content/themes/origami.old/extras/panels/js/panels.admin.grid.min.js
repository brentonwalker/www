/*
 GPL 2.0 http://www.gnu.org/licenses/gpl-2.0.html
*/
(function(a){var j=0,g=0;a.fn.panelsResizeCells=function(){return a(this).each(function(){var c=a(this);c.find(".grid, .grid .cell, .grid .cell .cell-wrapper").css("height","auto");var b=c.find(".grid").outerWidth();1<c.find(".grid .cell").length&&c.find(".grid .cell").each(function(){b=a(this).is(".first, .last")?b-6:b-12});var e=0,d=0;c.find(".grid .cell").each(function(){d=Math.max(d,a(this).height());a(this).width(Math.floor(b*Number(a(this).attr("data-percent")))).css("left",e);e+=a(this).width()+
12});c.find(".grid, .grid .cell, .grid .cell .cell-wrapper").css("height",Math.max(d,68))})};panels.createGrid=function(c,b){if(null==b||0==b.length){b=[];for(var e=0;e<c;e++)b[e]=1}var d=b.reduce(function(a,b){return a+b}),f=a("<div />").addClass("grid-container").appendTo("#panels-container");f.append(a('<input type="hidden" name="grids['+j+'][cells]" />').val(c));f.append(a('<div class="controls" />').append(a("<button />").button({icons:{primary:"ui-icon-remove"},text:!1}).attr("data-tooltip",
panels.i10n.buttons["delete"]).click(function(){a(this).removeTooltip();var b=[];f.find(".cell").each(function(e){b[e]={weight:Number(a(this).attr("data-percent")),widgets:[]};a(this).find(".panel").each(function(c){b[e].widgets[c]={type:a(this).attr("data-type"),data:a(this).getPanelData()}})});window.panels.undoManager.register(this,function(b,e){for(var c=[],d=0;d<b.length;d++)c[d]=b[d].weight;c=window.panels.createGrid(c.length,c);for(d=0;d<b.length;d++)for(var f=0;f<b[d].widgets.length;f++){var g=
b[d].widgets[f],g=a("#panels-dialog").panelsCreatePanel(g.type,g.data);window.panels.addPanel(g,c.find(".panels-container").eq(d))}e!=c.index()&&(d=a("#panels-container .grid-container").eq(e),d.length&&(c.insertBefore(d),a("#panels-container").sortable("refresh"),a("#panels-container").find(".cell").each(function(){a(this).find('input[name$="[grid]"]').val(a("#panels-container .grid-container").index(a(this).closest(".grid-container")))}),a("#panels-container .panels-container").trigger("refreshcells")));
a("#panels-container .panel").removeClass("new-panel");c.hide().slideDown()},[b,f.index()],"Remove Columns");a("#panels-undo-message").remove();a('<div id="panels-undo-message" class="updated"><p>'+panels.i10n.messages.deleteColumns+' - <a href="#" class="undo">'+panels.i10n.buttons.undo+"</a></p></div>").appendTo("body").hide().fadeIn().find("a.undo").click(function(){window.panels.undoManager.undo();a("#panels-undo-message").fadeOut(function(){a(this).remove()});return!1});f.slideUp(function(){f.remove();
a("#panels-container").sortable("refresh").find(".panels-container").trigger("refreshcells")});return!1})).append(a('<div class="ui-button ui-button-icon-only grid-handle"><div class="ui-icon ui-icon-move"></div></div>')));for(var k=a("<div />").addClass("grid").appendTo(f),e=0;e<c;e++){var h=a('<div class="cell" data-percent="'+b[e]/d+'"><div class="cell-wrapper panels-container"></div><div class="cell-width"><div class="cell-width-left"></div><div class="cell-width-right"></div><div class="cell-width-line"></div><div class="cell-width-value"><span></span></div></div></div>');
0==e&&h.addClass("first");e==c-1&&h.addClass("last");k.append(h);h.append(a('<input type="hidden" name="grid_cells['+g+'][weight]" />').val(b[e]/d)).append(a('<input type="hidden" name="grid_cells['+g+'][grid]" />').val(j)).data("cellId",g);g++}k.append(a("<div />").addClass("clear"));j++;panels.setupGrid(f);return f};panels.setupGrid=function(c){a("#panels-undo-message").fadeOut(function(){a(this).remove()});c.panelsResizeCells();c.find(".grid .cell").not(".first").each(function(){a(this).resizable({handles:"w",
containment:"parent",start:function(){a(this).prev().outerWidth();a(this).prev().position()},stop:function(){c.find(".grid .cell").not(".first").resizable("disable").resizable("enable")},resize:function(){var b=a(this),e=a(this).prev();e.css("width",b.position().left-e.position().left-12);var d=0;c.find(".grid .cell").each(function(){d+=a(this).width()}).each(function(){var b=a(this).width()/d;a(this).find(".cell-width-value span").html(Math.round(1E3*b)/10+"%");a(this).attr("data-percent",b).find('input[name$="[weight]"]').val(b)});
c.panelsResizeCells()}})});c.find(".grid .cell .ui-resizable-handle").dblclick(function(){var b=a(this).closest(".cell"),e=b.prev(),d=Number(b.attr("data-percent"))+Number(e.attr("data-percent"));b.attr("data-percent",d/2).find('input[name$="[weight]"]').val(d/2);e.attr("data-percent",d/2).find('input[name$="[weight]"]').val(d/2);b.add(e).find(".cell-width-value span").html(Math.round(1E3*(d/2))/10+"%");c.panelsResizeCells();return!1});c.find(".grid .cell").click(function(){a(".grid .cell").removeClass("cell-selected");
a(this).addClass("cell-selected")}).each(function(){var b=Number(a(this).attr("data-percent"));a(this).find(".cell-width-value span").html(Math.round(1E3*b)/10+"%")}).find(".panels-container").sortable({placeholder:"ui-state-highlight",connectWith:".panels-container",tolerance:"pointer",change:function(){var b=a("#panels-container .ui-state-highlight").closest(".cell").get(0);"undefined"!=typeof this.lastContainer&&this.lastContainer!=b&&(a(this.lastContainer).closest(".grid-container").panelsResizeCells(),
a(b).closest(".grid-container").panelsResizeCells(),b.click());this.lastContainer=b},helper:function(a,c){return c.clone().css("opacity",0.9).addClass("panel-being-dragged")},stop:function(){a("#panels-container .grid-container").each(function(){a(this).panelsResizeCells()})},receive:function(){a(this).trigger("refreshcells")}}).bind("refreshcells",function(){a("#panels-container .grid-container").each(function(){a(this).panelsResizeCells(!0)});a("#panels-container .panel").each(function(){var b=
a(this).closest(".grid-container");a(this).find('input[name$="[info][grid]"]').val(a("#panels-container .grid-container").index(b));a(this).find('input[name$="[info][cell]"]').val(b.find(".cell").index(a(this).closest(".cell")))});a("#panels-container .cell").each(function(){a(this).find('input[name$="[grid]"]').val(a("#panels-container .grid-container").index(a(this).closest(".grid-container")))})}).disableSelection()};panels.clearGrids=function(){a("#panels-container .grid-container").remove()}})(jQuery);